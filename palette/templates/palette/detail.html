{% extends 'base.html' %}
{% load static %}

{% block title %}
    {{ artwork.name }}
{% endblock %}

{% block content %}
    <div class="artwork-detail">
        <div>
            <img id="artwork-image" src="{{ artwork.image.url }}" alt="{{ artwork.name }} image">
        </div>

        <div>
            <h1 id="price-name">
                {{ artwork.name }}
            </h1>
            <h2><a href="{{ artwork.genre.get_absolute_url }}">{{ artwork.genre.name }}</a></h2>
            <p id="price" class="price">${{ artwork.price }}</p>
            {{ artwork.get_edition_display }} edition
            <br>
            {{ artwork.description | linebreaks}}
            <a href="{{ artwork.instagram_link }}">{{ artwork.artist }}</a>
            <br>
            <br>
            <span style="text-transform: lowercase; font-size: small;">{{ artwork.height }} x {{ artwork.width }} px</span>
            <br>
            <form action="{% url 'cart:cart-add' artwork.id %}" method="post" class="form-select">
                {{ form.as_p }}
                <input type="submit" value="Add to cart" class="add-button">
                {% csrf_token %}
            </form>
        </div>
    </div>
    <script>
        const img = document.getElementById('artwork-image');
        const name = document.getElementById('price-name');
        const price = document.getElementById('price');
        const colorThief = new ColorThief();

        // Helper function to calculate saturation
        function getSaturation(rgb) {
            const max = Math.max(rgb[0], rgb[1], rgb[2]);
            const min = Math.min(rgb[0], rgb[1], rgb[2]);
            return (max - min) / max;
        }
        
        // Helper function to calculate warmth (redness)
        function getWarmth(rgb) {
            return rgb[0] - Math.max(rgb[1], rgb[2]);
        }

        // Function to apply best color
        function applyBestColor(img) {
            const palette = colorThief.getPalette(img, 10);
            let bestColor = palette[0];
            let maxScore = getSaturation(palette[0]) + getWarmth(palette[0]);

            for (let i = 1; i < palette.length; i++) {
                const score = getSaturation(palette[i]) + getWarmth(palette[i]);
                if (score > maxScore) {
                    maxScore = score;
                    bestColor = palette[i];
                }
            }

            name.style.color = `rgb(${bestColor[0]}, ${bestColor[1]}, ${bestColor[2]})`;
            price.style.color = `rgb(${bestColor[0]}, ${bestColor[1]}, ${bestColor[2]})`;
        }

        // Ensure image is loaded before extracting color
        if (img.complete) {
            applyBestColor(img);
        } else {
            img.addEventListener('load', function() {
                applyBestColor(img);
            });
        }


        $(document).ready(function() {
            $('.form-select select').each(function(index) {
                $(this).attr('id', 'select-' + index).select2({
                    minimumResultsForSearch: Infinity, // Disable search box
                    width: 'auto'
                });
            });
        });
    </script>
{% endblock %} 